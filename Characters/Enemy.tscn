[gd_scene load_steps=7 format=2]

[ext_resource path="res://Ui/Heart2.png" type="Texture" id=1]
[ext_resource path="res://Curves/Bounce.tres" type="Curve" id=2]

[sub_resource type="Shader" id=2]
code = "shader_type canvas_item;
uniform float val = 0;
uniform vec4 col : hint_color;

void fragment(){
	vec4 tex = texture(TEXTURE,UV);
	COLOR = mix(tex,col,val);
	COLOR.a = tex.a;
}"

[sub_resource type="ShaderMaterial" id=3]
shader = SubResource( 2 )
shader_param/val = 0.0
shader_param/col = Color( 1, 0, 0.345098, 1 )

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D

var state = \"state_normal\"
var time = 0
export var hp = 3
var max_hp = hp
export var dmg = 15
export var enemy_name : String

export(Curve) var curve

onready var drop = $\"%Drop\"
onready var rewards = $\"%Rewards\"
onready var sprite = get_child(1)

func _ready():
	Events.connect(\"enemy_hit\",self,\"on_enemy_hit\")
	
func _process(delta):
	
	if has_method(state):
		call(state)

func attack():
	var t = create_tween()
	t.set_ease(Tween.EASE_OUT)
	t.set_trans(Tween.TRANS_BOUNCE)
	t.tween_property(self,\"position:y\",40,.2)
	t.tween_interval(.2)
	t.set_trans(Tween.TRANS_SINE)
	t.set_ease(Tween.EASE_OUT)
	t.tween_property(self,\"position:y\",0,.525)
	t.tween_callback(Events,\"emit_signal\",[\"reset_inventory\"])
	
	var tt = create_tween()
	tt.tween_interval(0.1)
	tt.tween_callback(Events,\"emit_signal\",[\"player_took_damage\",dmg])
	

	
func take_damage(val):
	hp -= val
	
	if hp <= 0:
		kill()
		return
	
	var t = create_tween()
	t.tween_method(self,\"bounce\",0.0,1.0,1)
	
	t.set_ease(Tween.EASE_OUT)
	t.set_trans(Tween.TRANS_BOUNCE)
	t.tween_property(self,\"position:y\",40,.2)
	t.tween_interval(.2)
	t.set_trans(Tween.TRANS_SINE)
	t.set_ease(Tween.EASE_OUT)
	t.tween_property(self,\"position:y\",0,.525)
	t.tween_callback(Events,\"emit_signal\",[\"reset_inventory\"])
	
	var tt = create_tween()
	tt.tween_interval(1.1)
	tt.tween_callback(Events,\"emit_signal\",[\"player_took_damage\",dmg])

func kill():
	drop.queue_free()
	Events.emit_signal(\"battle_ended\")
	
	var t = rewards.create_tween()
	t.set_ease(Tween.EASE_OUT)
	t.set_trans(Tween.TRANS_CUBIC)
	t.tween_property(rewards,\"position:y\",0,.35)
	t.tween_callback(Events,\"emit_signal\",[\"reset_inventory\"])
	
	var tt = create_tween()
	tt.tween_property(sprite,\"scale:x\",0.0,.5)
	tt.parallel().tween_property(sprite,\"scale:y\",5,.5)
	tt.parallel().tween_method(self,\"tween_shader\",0.0,1.0,.5)
	tt.tween_callback(self,\"queue_free\")

func tween_shader(val):
	material.set_shader_param(\"val\",val)

func bounce(val):
	var c = curve as Curve
	position.y = c.interpolate(val) * -15
"

[sub_resource type="GDScript" id=4]
script/source = "extends GridContainer

func _ready():
	set_as_toplevel(true)

func _process(delta):
	for heart in get_children():
		var i = heart.get_index()+1
		if i > owner.hp:
			heart.queue_free()

func _draw():
	var font = get_font(\"font\",\"default\")

	draw_string(font,Vector2(0,-8),owner.enemy_name.to_upper())
"

[node name="Enemy" type="Node2D"]
material = SubResource( 3 )
script = SubResource( 1 )
enemy_name = "Pyramimic"
curve = ExtResource( 2 )

[node name="HeartBar" type="GridContainer" parent="."]
margin_left = 77.0
margin_top = 67.0
margin_right = 393.0
margin_bottom = 203.0
mouse_filter = 2
columns = 10
script = SubResource( 4 )

[node name="Heart" type="TextureRect" parent="HeartBar"]
margin_right = 28.0
margin_bottom = 31.0
texture = ExtResource( 1 )

[node name="Heart2" type="TextureRect" parent="HeartBar"]
margin_left = 32.0
margin_right = 60.0
margin_bottom = 31.0
texture = ExtResource( 1 )

[node name="Heart3" type="TextureRect" parent="HeartBar"]
margin_left = 64.0
margin_right = 92.0
margin_bottom = 31.0
texture = ExtResource( 1 )

[node name="Heart4" type="TextureRect" parent="HeartBar"]
margin_left = 96.0
margin_right = 124.0
margin_bottom = 31.0
texture = ExtResource( 1 )

[node name="Heart5" type="TextureRect" parent="HeartBar"]
margin_left = 128.0
margin_right = 156.0
margin_bottom = 31.0
texture = ExtResource( 1 )

[node name="Heart6" type="TextureRect" parent="HeartBar"]
margin_left = 160.0
margin_right = 188.0
margin_bottom = 31.0
texture = ExtResource( 1 )

[node name="Heart7" type="TextureRect" parent="HeartBar"]
margin_left = 192.0
margin_right = 220.0
margin_bottom = 31.0
texture = ExtResource( 1 )

[node name="Heart8" type="TextureRect" parent="HeartBar"]
margin_left = 224.0
margin_right = 252.0
margin_bottom = 31.0
texture = ExtResource( 1 )

[node name="Heart9" type="TextureRect" parent="HeartBar"]
margin_left = 256.0
margin_right = 284.0
margin_bottom = 31.0
texture = ExtResource( 1 )

[node name="Heart10" type="TextureRect" parent="HeartBar"]
margin_left = 288.0
margin_right = 316.0
margin_bottom = 31.0
texture = ExtResource( 1 )

[node name="Heart11" type="TextureRect" parent="HeartBar"]
margin_top = 35.0
margin_right = 28.0
margin_bottom = 66.0
texture = ExtResource( 1 )

[node name="Heart12" type="TextureRect" parent="HeartBar"]
margin_left = 32.0
margin_top = 35.0
margin_right = 60.0
margin_bottom = 66.0
texture = ExtResource( 1 )

[node name="Heart13" type="TextureRect" parent="HeartBar"]
margin_left = 64.0
margin_top = 35.0
margin_right = 92.0
margin_bottom = 66.0
texture = ExtResource( 1 )

[node name="Heart14" type="TextureRect" parent="HeartBar"]
margin_left = 96.0
margin_top = 35.0
margin_right = 124.0
margin_bottom = 66.0
texture = ExtResource( 1 )

[node name="Heart15" type="TextureRect" parent="HeartBar"]
margin_left = 128.0
margin_top = 35.0
margin_right = 156.0
margin_bottom = 66.0
texture = ExtResource( 1 )

[node name="Heart16" type="TextureRect" parent="HeartBar"]
margin_left = 160.0
margin_top = 35.0
margin_right = 188.0
margin_bottom = 66.0
texture = ExtResource( 1 )

[node name="Heart17" type="TextureRect" parent="HeartBar"]
margin_left = 192.0
margin_top = 35.0
margin_right = 220.0
margin_bottom = 66.0
texture = ExtResource( 1 )

[node name="Heart18" type="TextureRect" parent="HeartBar"]
margin_left = 224.0
margin_top = 35.0
margin_right = 252.0
margin_bottom = 66.0
texture = ExtResource( 1 )

[node name="Heart19" type="TextureRect" parent="HeartBar"]
margin_left = 256.0
margin_top = 35.0
margin_right = 284.0
margin_bottom = 66.0
texture = ExtResource( 1 )

[node name="Heart20" type="TextureRect" parent="HeartBar"]
margin_left = 288.0
margin_top = 35.0
margin_right = 316.0
margin_bottom = 66.0
texture = ExtResource( 1 )

[node name="Heart21" type="TextureRect" parent="HeartBar"]
margin_top = 70.0
margin_right = 28.0
margin_bottom = 101.0
texture = ExtResource( 1 )

[node name="Heart22" type="TextureRect" parent="HeartBar"]
margin_left = 32.0
margin_top = 70.0
margin_right = 60.0
margin_bottom = 101.0
texture = ExtResource( 1 )

[node name="Heart23" type="TextureRect" parent="HeartBar"]
margin_left = 64.0
margin_top = 70.0
margin_right = 92.0
margin_bottom = 101.0
texture = ExtResource( 1 )

[node name="Heart24" type="TextureRect" parent="HeartBar"]
margin_left = 96.0
margin_top = 70.0
margin_right = 124.0
margin_bottom = 101.0
texture = ExtResource( 1 )

[node name="Heart25" type="TextureRect" parent="HeartBar"]
margin_left = 128.0
margin_top = 70.0
margin_right = 156.0
margin_bottom = 101.0
texture = ExtResource( 1 )

[node name="Heart26" type="TextureRect" parent="HeartBar"]
margin_left = 160.0
margin_top = 70.0
margin_right = 188.0
margin_bottom = 101.0
texture = ExtResource( 1 )

[node name="Heart27" type="TextureRect" parent="HeartBar"]
margin_left = 192.0
margin_top = 70.0
margin_right = 220.0
margin_bottom = 101.0
texture = ExtResource( 1 )

[node name="Heart28" type="TextureRect" parent="HeartBar"]
margin_left = 224.0
margin_top = 70.0
margin_right = 252.0
margin_bottom = 101.0
texture = ExtResource( 1 )

[node name="Heart29" type="TextureRect" parent="HeartBar"]
margin_left = 256.0
margin_top = 70.0
margin_right = 284.0
margin_bottom = 101.0
texture = ExtResource( 1 )

[node name="Heart30" type="TextureRect" parent="HeartBar"]
margin_left = 288.0
margin_top = 70.0
margin_right = 316.0
margin_bottom = 101.0
texture = ExtResource( 1 )

[node name="Heart31" type="TextureRect" parent="HeartBar"]
margin_top = 105.0
margin_right = 28.0
margin_bottom = 136.0
texture = ExtResource( 1 )

[node name="Heart32" type="TextureRect" parent="HeartBar"]
margin_left = 32.0
margin_top = 105.0
margin_right = 60.0
margin_bottom = 136.0
texture = ExtResource( 1 )

[node name="Heart33" type="TextureRect" parent="HeartBar"]
margin_left = 64.0
margin_top = 105.0
margin_right = 92.0
margin_bottom = 136.0
texture = ExtResource( 1 )

[node name="Heart34" type="TextureRect" parent="HeartBar"]
margin_left = 96.0
margin_top = 105.0
margin_right = 124.0
margin_bottom = 136.0
texture = ExtResource( 1 )

[node name="Heart35" type="TextureRect" parent="HeartBar"]
margin_left = 128.0
margin_top = 105.0
margin_right = 156.0
margin_bottom = 136.0
texture = ExtResource( 1 )

[node name="Heart36" type="TextureRect" parent="HeartBar"]
margin_left = 160.0
margin_top = 105.0
margin_right = 188.0
margin_bottom = 136.0
texture = ExtResource( 1 )

[node name="Heart37" type="TextureRect" parent="HeartBar"]
margin_left = 192.0
margin_top = 105.0
margin_right = 220.0
margin_bottom = 136.0
texture = ExtResource( 1 )

[node name="Heart38" type="TextureRect" parent="HeartBar"]
margin_left = 224.0
margin_top = 105.0
margin_right = 252.0
margin_bottom = 136.0
texture = ExtResource( 1 )

[node name="Heart39" type="TextureRect" parent="HeartBar"]
margin_left = 256.0
margin_top = 105.0
margin_right = 284.0
margin_bottom = 136.0
texture = ExtResource( 1 )

[node name="Heart40" type="TextureRect" parent="HeartBar"]
margin_left = 288.0
margin_top = 105.0
margin_right = 316.0
margin_bottom = 136.0
texture = ExtResource( 1 )
